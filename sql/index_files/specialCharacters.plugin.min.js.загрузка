/*
 kl/editor-manager/plugins/klSpecialChars.plugin.js
 License https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode
 Copyright 2017 Lukas Wieditz
*/
(function(d){d(document).on("editor:config",function(C,D,c){function x(){h();XF.EditorHelpers.blur(c.ed);var a=c.ed.$tb.find('.fr-command[data-cmd="specialCharacters"]');if(!k){k=!0;b=d(d.parseHTML(Mustache.render(d(".js-specialCharacters").first().html())));b.insertAfter(a);a.data("xf-click","menu");var l=XF.Event.getElementHandler(a,"menu","click");b.on("menu:complete",function(){g=b.find(".menu-scroller");if(!r){r=!0;g.find(".js-specialCharacter").on("click",n);var a=b.find(".js-specialCharacterSearch");
a.on("focus",h);a.on("blur",y);a.on("input",z);b.find(".js-specialCharsCloser").on("click",function(){XF.EditorHelpers.focus(c.ed)});d(document).on("recent-klem-special-character:logged",A);c.ed.events.on("commands.mousedown",function(a){"specialCharacters"!=a.data("cmd")&&l.close()});b.on("menu:closed",function(){t=g.scrollTop()})}g.scrollTop(t)});b.on("menu:closed",function(){setTimeout(function(){c.ed.markers.remove()},50)})}(a=a.data("xfClickHandlers"))&&a.menu&&a.menu.toggle()}function n(a){var l=
d(a.currentTarget);a=l.html();d(a);XF.EditorHelpers.focus(c.ed);c.ed.html.insert(a);h();XF.EditorHelpers.blur(c.ed);if(b){var e=b.find(".js-specialCharacterInsertedRow");e.find(".js-specialCharacterInsert").html(a);e.addClassTransitioned("is-active");clearTimeout(u);u=setTimeout(function(){e.removeClassTransitioned("is-active")},1500)}clearTimeout(v);v=setTimeout(function(){var a=l.data("id");a=d.trim(a);var b=XF.Feature.has("hiddenscroll")?12:11,f=XF.Cookie.get("klem_specialcharacter_usage");f=f?
f.split(","):[];var e=f.indexOf(a);-1!==e&&f.splice(e,1);f.push(a);f.length>b&&(f=f.reverse().slice(0,b).reverse());XF.Cookie.set("klem_specialcharacter_usage",f.join(","),new Date((new Date).setFullYear((new Date).getFullYear()+1)));d(document).trigger("recent-klem-special-character:logged")},1500)}function z(){var a=d(this),c=b.find(".js-specialCharacterFullList"),e=b.find(".js-specialCharacterSearchResults");clearTimeout(w);w=setTimeout(function(){var b=a.val();if(!b||2>b.length)e.hide(),c.show();
else{var d=XF.canonicalizeUrl("index.php?editor/kl-em-special-chars/search");XF.ajax("GET",d,{q:b},function(a){a.html&&XF.setupHtmlInsert(a.html,function(a){a.find(".js-specialCharacter").on("click",n);c.hide();e.replaceWith(a)})})}},300)}function B(){var a=XF.Cookie.get("klem_specialcharacter_usage");return(a?a.split(","):[]).reverse()}function A(){var a=B(),b=g.find(".js-recentHeader"),e=g.find(".js-recentBlock"),c=e.find(".js-recentList"),h=g.find(".js-specialCharacterList");if(a){var f=c.clone(),
p=[];f.empty();for(var q in a){var k=a[q],m;h.each(function(){m=d(this).find('.js-specialCharacter[data-id="'+k+'"]').closest("li").clone();if(m.length)return m.find(".js-specialCharacter").on("click",n),p.push(m),!1})}for(q in p)p[q].appendTo(f);c.replaceWith(f);e.hasClass("is-hidden")&&(e.hide(),e.removeClass("is-hidden"),b.removeClass("is-hidden"),e.xfFadeDown(XF.config.speed.fast))}}function h(){c.ed.selection.save()}function y(){c.ed.selection.restore()}var k=!1,r=!1,b,g,t=0,u,v,w;d.FE.DefineIcon("klSpecialChars",
{NAME:"omega"});d.FE.RegisterCommand("specialCharacters",{title:"Special Characters",icon:"klSpecialChars",undo:!1,focus:!1,refreshOnCallback:!1,callback:function(){x()}})})})(jQuery);